<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <link href="styles2.css" rel="stylesheet">
</head>


<body>

<svg viewBox="-1 -1 2 2" style="transform: rotate(-90deg)"></svg>


<script>

    //Pie chart:
    var svgEl = document.querySelector('svg');
    var cumulativePercent = 0;
    var slices = [];
    var colors = ['#007bff', '#6610f2', '#dc3545', '#28a745', '#fd7e14', '#17a2b8', '#ffc107', '#20c997'];

    function getCoordinatesForPercent(percent) {
        const x = Math.cos(2 * Math.PI * percent);
        const y = Math.sin(2 * Math.PI * percent);
        return [x, y];
    }

    function renderPie(resp) {
        var nutrients = {'fat': 0, 'protein': 0, 'carbon': 0, 'sugar': 0, 'fiber': 0, 'vitaminsMinerals': 0, 'water': 0};
        var total_all=0;

        resp.forEach(food => {
            var total = 0;
            food.foodNutrients.forEach(item => {
                var nutrient = item.nutrient;

                if (nutrient.unitName == "g") scale = 1;
                if (nutrient.unitName == "mg") scale = 0.001;
                if (nutrient.unitName == "ug") scale = 1 / 1000000;

                var amount = item.amount * scale;
                //if (nutrient.name != "Energy") {
                total += amount;
                //}

                if (nutrient.name == "Total lipid (fat)") nutrients.fat += amount;
                if (nutrient.name == "Protein") nutrients.protein += amount;
                if (nutrient.name == "Carbohydrate, by difference") nutrients.carbon += amount;
                if (nutrient.name == "Sugars, total including NLEA") nutrients.sugar += amount;
                if (nutrient.name == "Fiber, total dietary") nutrients.fiber += amount;
                if (nutrient.name == "Water") nutrients.water += amount;
            })
            //nutrients.water += 100 - total;//total for all nutrients
            //if (nutrients.water < 0) {
            //    nutrients.water = 0;
            //}
        })

        //total += nutrients.water;
        //nutrients.water = 0;

        //nutrients.vitaminsMinerals = total - (nutrients.protein + nutrients.fat + nutrients.carbon + nutrients.fiber + nutrients.sugar);
        //console.log(total);

        slices = [];
        var debug = 0;

        // Calculate percentages
        for (const [key, value] of Object.entries(nutrients)) {
            //var percent = value / total_all * 10;
            var percent = value / (100*food.length) * 10;
            slices.push({ percent: percent, color: colors[Object.keys(nutrients).indexOf(key)], name: key });
            debug += percent;
        }

        console.log(slices, debug);

        /*slices = [
          { percent: 0.1, color: 'Coral' },
          { percent: 0.65, color: 'CornflowerBlue' },
          { percent: 0.2, color: '#00ab6b' },
        ];*/

        slices.forEach(slice => {
            // destructuring assignment sets the two variables at once
            const [startX, startY] = getCoordinatesForPercent(cumulativePercent);

            // each slice starts where the last slice ended, so keep a cumulative percent
            cumulativePercent += slice.percent;

            const [endX, endY] = getCoordinatesForPercent(cumulativePercent);

            // if the slice is more than 50%, take the large arc (the long way around)
            const largeArcFlag = slice.percent > .5 ? 1 : 0;

            // create an array and join it just for code readability
            const pathData = [
                `M ${startX} ${startY}`, // Move
                `A 1 1 0 ${largeArcFlag} 1 ${endX} ${endY}`, // Arc
                `L 0 0`, // Line
            ].join(' ');

            // create a <path> and append it to the <svg> element
            const pathEl = document.createElementNS('http://www.w3.org/2000/svg', 'path');
            pathEl.setAttribute('d', pathData);
            pathEl.setAttribute('fill', slice.color);
            const titleEl = document.createElementNS('http://www.w3.org/2000/svg', 'title');
            titleEl.innerHTML = slice.name;
            svgEl.appendChild(pathEl);
            pathEl.appendChild(titleEl);
        });
    }

    var ids = ['786790', '577849'];
    var url = 'https://api.nal.usda.gov/fdc/v1/foods?api_key=MVPaBrywVMVDkVehW8DCZ2AjcbJhEJhfVpfGq1im&fdcIds='+ids.join();

    httpRequest('GET', url, renderPie);

    function httpRequest(type, url, callback) {
        var xmlhttp = new XMLHttpRequest();
        xmlhttp.onreadystatechange = function() {
            if (this.readyState == 4 && this.status == 200) {
                var response = JSON.parse(this.responseText);
                callback(response);
            }
        }
        xmlhttp.open(type, url, true);
        xmlhttp.send();
    }
</script>

</body>
</html>